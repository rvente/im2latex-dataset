#!/bin/python2
# coding: utf-8

# ### Generate Formula List
# &copy; Copyright 2017 Sumeet S Singh
# 
#     This file is part of im2latex-dataset.
# 
#     This program is free software: you can redistribute it and/or modify
#     it under the terms of the Affero GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
# 
#     This program is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     Affero GNU General Public License for more details.
# 
#     You should have received a copy of the Affero GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#     
# This notebook generates the formula list in the same format as im2latex_formulas.lst. However, unlike the file im2latex_formulas.lst which is generated by the formula2img.py, this script actually goes through the list of files present on disk and compiles their list. Therefore it is more reliable than the output from formula2img.py which can misalign formulas with file-names (see the code).

# In[ ]:

import os
import argparse
import sys
import pandas as pd
import hashlib
from six.moves import cPickle as pickle

MAP_FILE = 'im2latex_map.pkl'
MAP_FILE_CSV = 'im2latex_map.csv'
FORMULA_LIST_FILE = 'im2latex_formula.txt'
DATASET_LIST_FILE = 'im2latex_dataset.txt'

parser = argparse.ArgumentParser(description='Generate Formula List: Generates a text file mapping latex formulas taken from a given input file and corresponding image files present in a given folder.')
parser.add_argument('formula_file', help='Path of text file with one latex formula per line')
parser.add_argument('image_dir', help='Directory/folder where the generated image files are present')
parser.add_argument('-r', '--rendering_setup', default='basic', help='Name of rendering setup files to cull. Defaults to "basic"')
parser.add_argument('-o', action="store_true", help='Overwrite the output file even if it exists. Without this flag the output file will not be overwritten if it exits')

args = parser.parse_args()

formula_file = args.formula_file
image_dir = args.image_dir

setup = args.rendering_setup
ovw = args.o

def assertFiles():
    if not ovw and os.path.exists(MAP_FILE):
        print('%s already exists. Specify the -o flag to overwrite'%(MAP_FILE,))
        exit(1)
    if not ovw and os.path.exists(FORMULA_LIST_FILE):
        print('%s already exists. Specify the -o flag to overwrite'%(FORMULA_LIST_FILE,))
        exit(1)
    if not ovw and os.path.exists(DATASET_LIST_FILE):
        print('%s already exists. Specify the -o flag to overwrite'%(DATASET_LIST_FILE,))
        exit(1)


MAX_NUMBER = 150*1000
data_map = []
assertFiles()

# Load the formula_file using the same code that formula2img.py uses so that we get the same formula list.
formulas = open(formula_file).read().split("\n")[:MAX_NUMBER]
for formula in formulas:
    try:
        formula = formula.strip("%").encode('utf-8')
        formula_name = hashlib.sha1(formula).hexdigest()[:15] + '_' + setup
        filename =  formula_name + '.png'
    except Exception as e:
        #print(e)
        print('Error processing formula line "%s". Moving on ...'%(formula,))
        continue
    filepath = os.path.join(image_dir, filename)
    if (os.path.isfile(filepath) and (os.lstat(filepath).st_size > 0)):
        data_map.append([filename, formula_name, formula])
    else:
        print("Didn't find file "+filepath)

print('Generated %d rows'%(len(data_map),))
mapDF = pd.DataFrame(data_map, columns=['image', 'formula_name', 'latex'])
print('Dataframe shape=%s'%(mapDF.shape,))

assertFiles()
    
mapDF.to_pickle(MAP_FILE)
print('Wrote %s'%(MAP_FILE,))
#mapDF.to_csv(MAP_FILE_CSV, index=False)
#print('Wrote %s'%(MAP_FILE_CSV,))
mapDF.latex.to_csv(FORMULA_LIST_FILE, sep=" ", header=False, index=False)
print('Wrote %s'%(FORMULA_LIST_FILE,))
formulaDF = mapDF.assign(setup=setup)
formulaDF[['formula_name', 'setup']].to_csv(DATASET_LIST_FILE, sep=" ", header=False, index=True)
print('Wrote %s'%(DATASET_LIST_FILE,))